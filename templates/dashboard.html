<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="/static/echarts.min.js"></script>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    .chart-container {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
    }
    .chart-box {
      flex: 1 1 45%;
      min-width: 400px;
      height: 400px;
      background: #1e1e1e;
      padding: 10px;
      border-radius: 10px;
    }
    a {
      color: #66ccff;
    }
    table {
      background: #1e1e1e;
      color: #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
    }
    .button-primary {
      padding: 10px 20px;
      background: #0f62fe;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>üå°Ô∏è Sensor Dashboard</h2>

  <nav id="node-nav" style="margin-bottom: 20px;">
    <strong>Jump to Node:</strong>
    <span id="node-links">Loading...</span>
  </nav>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="background: #222; border-left: 4px solid #0f62fe; padding: 10px 15px; margin-bottom: 20px; border-radius: 5px;">
        {% for msg in messages %}
          <p style="margin: 0; color: #ddd;">{{ msg }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h3>Latest Readings</h3>
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
    <thead>
      <tr style="border-bottom: 1px solid #444;">
        <th align="left">Node</th>
        <th align="left">Temperature (¬∞C)</th>
        <th align="left">Humidity (%)</th>
        <th align="left">Last Updated</th>
      </tr>
    </thead>
    <tbody id="latest-rows">
      {% for node, metrics in latest_metrics.items() %}
        <tr>
          <td>{{ node }}</td>
          <td>{{ "%.2f"|format(metrics.temperature) if metrics.temperature is not none else "‚Äî" }}</td>
          <td>{{ "%.2f"|format(metrics.relativeHumidity) if metrics.relativeHumidity is not none else "‚Äî" }}</td>
          <td>{{ last_seen[node] }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="display: flex; justify-content: center; margin-bottom: 20px;">
    <form id="telemetry-form" method="POST" action="/trigger">
      <button id="telemetry-button" type="submit" class="button-primary">
        üì° Request Telemetry
      </button>
    </form>
  </div>

  <div class="chart-container">
    {% for metric, nodes in chart_data.items() %}
      <div id="{{ metric }}" class="chart-box"></div>
    {% endfor %}
  </div>

  <div id="loading-overlay" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: rgba(18, 18, 18, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: #fff;
    font-size: 1.5em;
    flex-direction: column;
  ">
    <div class="spinner" style="
      border: 8px solid #333;
      border-top: 8px solid #0f62fe;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    "></div>
    Updating sensor data...
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize charts
      const chartData = {{ chart_data | tojson }};
      for (const metric in chartData) {
        const chart = echarts.init(document.getElementById(metric), 'dark');
        const series = Object.entries(chartData[metric]).map(([node, data]) => ({
          name: node,
          type: 'line',
          smooth: true,
          data: data
        }));
        chart.setOption({
          title: { text: metric + ' Over Time' },
          tooltip: { trigger: 'axis' },
          legend: { data: Object.keys(chartData[metric]) },
          xAxis: { type: 'time' },
          yAxis: { type: 'value' },
          series: series
        });
      }

      // Load node links
      fetch('/nodes')
        .then(res => res.json())
        .then(nodes => {
          const nav = document.getElementById('node-links');
          nav.innerHTML = nodes.map(n =>
            `<a href="/node/${n.id}" style="margin-right: 10px;">${n.name}</a>`
          ).join('');
        });

      // Live update summary
      function updateLatest() {
        fetch('/latest-data')
          .then(res => res.json())
          .then(data => {
            const tbody = document.getElementById('latest-rows');
            tbody.innerHTML = '';
            for (const node in data.metrics) {
              const temp = data.metrics[node].temperature?.toFixed(2) ?? '‚Äî';
              const rh = data.metrics[node].relativeHumidity?.toFixed(2) ?? '‚Äî';
              const updated = data.lastSeen[node] ?? '‚Äî';
              tbody.innerHTML += `<tr>
                <td>${node}</td>
                <td>${temp}</td>
                <td>${rh}</td>
                <td>${updated}</td>
              </tr>`;
            }
          });
      }
      updateLatest();
      setInterval(updateLatest, 15000);

      // Cooldown + spinner logic
      const cooldownMinutes = 5;
      const cooldownKey = "lastTelemetryRequest";
      const button = document.getElementById("telemetry-button");
      const form = document.getElementById("telemetry-form");

      function updateCooldownState() {
        const lastRequest = localStorage.getItem(cooldownKey);
        if (lastRequest) {
          const elapsed = (Date.now() - parseInt(lastRequest, 10)) / 60000;
          if (elapsed < cooldownMinutes) {
            const remaining = Math.ceil(cooldownMinutes - elapsed);
            button.disabled = true;
            button.innerText = `‚è≥ Wait ${remaining} min...`;
            return;
          }
        }
        button.disabled = false;
        button.innerText = "üì° Request Telemetry";
      }

      form.addEventListener("submit", () => {
        localStorage.setItem(cooldownKey, Date.now().toString());
        updateCooldownState();
        document.getElementById('loading-overlay').style.display = 'flex';
      });

      updateCooldownState();
      setInterval(updateCooldownState, 30000);
    });
  </script>
</body>
</html>
